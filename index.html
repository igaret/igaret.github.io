<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DNS-over-HTTPS Multi-Type Query</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    .output { margin-top: 1em; padding: 1em; background: #f0f0f0; border-radius: 5px; }
    code { background: #e0e0e0; padding: 2px 4px; border-radius: 3px; }
    h2 { margin-top: 1.5em; }
  </style>
</head>
<body>
  <h1>DNS-over-HTTPS Query Tool</h1>
  <p>This page parses the URL fragment and performs DNS queries using Google's DoH API.</p>
  <div class="output" id="output">Waiting for fragment...</div>

  <script>
    async function queryDNS(domain, type, mimetype) {
      const url = `https://dns.google/resolve?name=${encodeURIComponent(domain)}&type=${encodeURIComponent(type)}`;
      const res = await fetch(url, {
        headers: { 'Accept': mimetype === 'json' ? 'application/dns-json' : 'application/dns-message' }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return mimetype === 'json' ? await res.json() : await res.arrayBuffer();
    }

    async function parseAndQueryDNS() {
      const fragment = window.location.hash.substring(1);
      const params = new URLSearchParams(fragment);
      const output = document.getElementById('output');

      if (!params.has('dns-query')) {
        output.textContent = 'No dns-query modifier found.';
        return;
      }

      const domain = params.get('domain');
      const types = (params.get('type') || 'A').split('+').map(t => t.trim().toUpperCase());
      const mimetype = params.get('mimetype') || 'json';
      const humanReadable = params.get('human-readable') === '1';
      const wildcard = params.get('wildcard') === '1';

      if (!domain) {
        output.textContent = 'Missing domain parameter.';
        return;
      }

      const subdomains = wildcard ? ['www', 'mail', 'test', 'foo', 'bar'] : [''];
      output.innerHTML = `<strong>Querying DNS records for:</strong> ${domain}<br><em>Types:</em> ${types.join(', ')}<br><em>Wildcard:</em> ${wildcard ? 'enabled' : 'disabled'}<br><br>`;

      for (const sub of subdomains) {
        const fqdn = sub ? `${sub}.${domain}` : domain;
        output.innerHTML += `<h2>${fqdn}</h2>`;
        for (const type of types) {
          try {
            const data = await queryDNS(fqdn, type, mimetype);

            if (mimetype !== 'json') {
              output.innerHTML += `<strong>${type}:</strong> Binary response received.<br>`;
              continue;
            }

            if (humanReadable && data.Answer) {
              output.innerHTML += `<strong>${type} Records:</strong><ul>`;
              for (const record of data.Answer) {
                output.innerHTML += `<li><strong>Data:</strong> ${record.data} <br><strong>TTL:</strong> ${record.TTL} seconds</li>`;
              }
              output.innerHTML += '</ul>';
            } else {
              output.innerHTML += `<strong>${type} Raw JSON:</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
          } catch (err) {
            output.innerHTML += `<strong>${type} Error:</strong> ${err.message}<br>`;
          }
        }
      }
    }

    window.addEventListener('load', parseAndQueryDNS);
    window.addEventListener('hashchange', parseAndQueryDNS);
  </script>
</body>
</html>